(function(e){var t=/[\-\[\]{}()*+?.,\\\^$|#\s]/g;e.widget("ech.multiselectfilter",{options:{label:"Filter:",width:null,placeholder:"Enter keywords",autoReset:false},_create:function(){var t=this,n=this.options,r=this.instance=e(this.element).data("multiselect"),i=this.header=r.menu.find(".ui-multiselect-header").addClass("ui-multiselect-hasfilter"),s=this.wrapper=e('<div class="ui-multiselect-filter">'+(n.label.length?n.label:"")+'<input placeholder="'+n.placeholder+'" type="search"'+(/\d/.test(n.width)?'style="width:'+n.width+'px"':"")+" /></div>").prependTo(this.header);this.inputs=r.menu.find('input[type="checkbox"], input[type="radio"]');this.input=s.find("input").bind({keydown:function(e){if(e.which===13){e.preventDefault()}if(e.which===9){r.close();e.preventDefault()}if(e.which===39||e.which===40){r.menu.find('input[type="checkbox"]:visible, input[type="radio"]:visible')[0].focus();r.menu.find("label:visible").first().trigger("mouseover");e.preventDefault()}if(e.which===37||e.which===38){r.menu.find('input[type="checkbox"]:visible, input[type="radio"]:visible')[inputs.length-1].focus();r.menu.find("label:visible").last().trigger("mouseover");e.preventDefault()}},keyup:e.proxy(t._handler,t),click:e.proxy(t._handler,t)});this.updateCache();r._toggleChecked=function(n,r){var i=r&&r.length?r:this.labels.find("input"),s=this,o=t.instance._isOpen?":disabled, :hidden":":disabled";i=i.not(o).each(this._toggleState("checked",n));this.update();var u=i.map(function(){return this.value}).get();this.element.find("option").filter(function(){if(!this.disabled&&e.inArray(this.value,u)>-1){s._toggleState("selected",n).call(this)}})};var o=e(document).bind("multiselectrefresh",function(){t.updateCache();t._handler()});if(this.options.autoReset){o.bind("multiselectclose",e.proxy(this._reset,this))}},_handler:function(n){var r=e.trim(this.input[0].value.toLowerCase()),i=this.rows,s=this.inputs,o=this.cache;if(!r){i.show()}else{i.hide();var u=new RegExp(r.replace(t,"\\$&"),"gi");this._trigger("filter",n,e.map(o,function(e,t){if(e.search(u)!==-1){i.eq(t).show();return s.get(t)}return null}))}this.instance.menu.find(".ui-multiselect-optgroup-label").each(function(){var t=e(this);var n=t.nextUntil(".ui-multiselect-optgroup-label").filter(function(){return e.css(this,"display")!=="none"}).length;t[n?"show":"hide"]()})},_reset:function(){this.input.val("").trigger("keyup")},updateCache:function(){this.rows=this.instance.menu.find(".ui-multiselect-checkboxes li:not(.ui-multiselect-optgroup-label)");this.cache=this.element.children().map(function(){var t=e(this);if(this.tagName.toLowerCase()==="optgroup"){t=t.children()}return t.map(function(){return this.innerHTML.toLowerCase()}).get()}).get()},widget:function(){return this.wrapper},destroy:function(){e.Widget.prototype.destroy.call(this);this.input.val("").trigger("keyup");this.wrapper.remove()}})})(jQuery)
